{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Recarga de m√°quinas expendedoras - Flash24AdminApp">
    <title>Recarga de M√°quinas Expendedoras</title>
    <link rel="stylesheet" href="{% static 'actualizarStock.css' %}">
</head>
<body>
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="{% url 'index' %}" class="btn btn-secondary back-home-btn" title="Volver al inicio">
                    <span>üè†</span>
                    <span>Volver</span>
                </a>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="main-content">
            <!-- Header -->
            <div class="content-header">
                <h1>üîÑ Recarga de M√°quinas Expendedoras</h1>
                <p>Registra las recargas y gestiona el inventario de productos</p>
            </div>

            <!-- Alertas -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Formulario de recarga -->
            <div class="form-container">
                <div class="form-title">Formulario de Recarga</div>

                <form method="POST" novalidate>
                    {% csrf_token %}

                    <div class="form-grid">
                        <!-- Campo: Ciudad -->
                        <div class="form-group">
                            <label for="ciudad">Ciudad:</label>
                            <select name="ciudad" id="ciudad" onchange="location.href='?ciudad='+this.value" required aria-label="Selecciona una ciudad">
                                <option value="">Selecciona una ciudad</option>
                                {% for ciudad in ciudades %}
                                    <option value="{{ ciudad.id }}" {% if ciudad.id == ciudad_seleccionada %}selected{% endif %}>
                                        {{ ciudad.nombre }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Campo: M√°quina -->
                        <div class="form-group">
                            <label for="maquina">M√°quina a recargar:</label>
                            <select name="maquina" id="maquina" required aria-label="Selecciona una m√°quina">
                                <option value="">Selecciona una m√°quina</option>
                                {% for maquina in maquinas %}
                                    <option value="{{ maquina.idMaquina }}">
                                        {{ maquina.nombre }} - {{ maquina.ubicacion }}
                                    </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-sm btn-secondary" id="btnCrearMaquinaRapido" 
                                    onclick="abrirModalMaquina()">Nueva Maquina</button>
                        </div>
                        <!-- MODAL DE M√°quina -->
                            <div id="modalNuevaMaquina" class="modal-overlay" style="display: none;">
                            <div class="modal-content">
                                <h3>‚ú® Nueva M√°quina</h3>
                                <form id="formNuevaMaquina">
                                    <div class="form-group">
                                        <label>Nombre de la maquina:</label>
                                        <input type="text" id="nuevo_nombre_maquina" required placeholder="Ej: Cafetera 1">
                                        <label>Ubicacion:</label>
                                        <input type="text" id="nuevo_ubicacion_maquina" required placeholder="Ej: UNFRAF">
                                    </div>
                                    <div class="modal-actions">
                                        <button type="button" class="btn-cancel" onclick="cerrarModalMaquina()">Cancelar</button>
                                        <button type="button" class="btn-save" id="btnGuardarMaquina">Guardar M√°quina</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                            


                        <!-- Campo: B√∫squeda de Producto -->
                        <div class="form-group">
                            <label for="producto-search">Producto a cargar:</label>
                            <div class="search-container">
                                <input type="text" id="producto-search" placeholder="Escribe para buscar..." autocomplete="off" aria-label="Buscar productos" aria-describedby="search-help">
                                <input type="hidden" name="producto" id="producto" required>
                                <div class="search-results" id="search-results" role="listbox"></div>
                            </div>
                        </div>

                        <!-- Campo: Cantidad -->
                        <div class="form-group">
                            <label for="cantidad">Cantidad del producto a cargar en maquina:</label>
                            <input type="number" name="cantidad" id="cantidad" min="1" required aria-label="Cantidad a cargar" placeholder="Ingresa la cantidad">
                        </div>

                        <!-- Campo: Usuario (oculto) -->
                        <div class="form-group" style="display: none;">
                            <label for="usuario">Usuario responsable:</label>
                            <select name="usuario" id="usuario" required>
                                <option value="{{ request.session.user_id }}" selected>{{ request.session.user_name }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn" aria-label="Registrar recarga de producto">
                            <span>‚úÖ</span>
                            <span>Registrar Recarga</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de productos -->
            {% if ciudad_seleccionada %} 
            <div class="products-section">
                <div class="products-header">
                    <div>
                        <div class="products-title">üåÜ Stock en: {{ ciudad.nombre }}</div>
                    </div>
                    <div>
                        <div class="products-title">üì¶ Inventario de Productos</div>
                    </div>
                </div>

                {% if productos %}
                    <div class="table-responsive">
                        <table class="products-table" role="table">
                            <thead>
                                <tr>
                                    <th scope="col">Producto</th>
                                    <th scope="col">Marca</th>
                                    <th scope="col">Stock Disponible</th>
                                    <th scope="col">Estado</th>
                                    <th scope="col">Precio Unitario</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos %}
                                    <tr>
                                        <td>
                                            <div class="product-name">{{ producto.nombre }}</div>
                                        </td>
                                        <td>
                                            <div class="product-brand">{{ producto.marca }}</div>
                                        </td>
                                        <td>
                                            <div class="stock-amount
                                                {% if producto.stock.cantidadDisponible > 50 %}stock-high
                                                {% elif producto.stock.cantidadDisponible > 20 %}stock-medium
                                                {% else %}stock-low{% endif %}">
                                                {{ producto.stock.cantidadDisponible|default:0 }} unidades
                                            </div>
                                        </td>
                                        <td>
                                            {% if producto.stock.cantidadDisponible > 50 %}
                                                <span class="stock-status status-high">Alto</span>
                                            {% elif producto.stock.cantidadDisponible > 20 %}
                                                <span class="stock-status status-medium">Medio</span>
                                            {% else %}
                                                <span class="stock-status status-low">Bajo</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="price">${{ producto.precioUnitario }}</div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="icon">üì¶</div>
                        <h3>No hay productos disponibles</h3>
                        <p>Agrega productos al sistema para comenzar a gestionar el inventario.</p>
                    </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <div class="icon">üåÜ</div>
                    <h3>Selecciona una ciudad para ver el inventario</h3>
                    <p>Elige una ciudad en el formulario de recarga para cargar su inventario de productos.</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>

    <!-- Datos de productos para JavaScript -->
    <script>
        const productosData = [
            {% for producto in productos %}
            {
                id: {{ producto.id }},
                nombre: "{{ producto.nombre }}",
                marca: "{{ producto.marca }}",
                stock: {{ producto.stock.cantidadDisponible|default:0 }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    </script>

    <!-- Script de b√∫squeda din√°mica -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('producto-search');
            const hiddenInput = document.getElementById('producto');
            const searchResults = document.getElementById('search-results');
            let selectedIndex = -1;
            let filteredProducts = [];

            // Funci√≥n para filtrar productos
            function filterProducts(query) {
                if (query.length < 2) {
                    return [];
                }
                
                const lowerQuery = query.toLowerCase();
                return productosData.filter(producto => 
                    producto.nombre.toLowerCase().includes(lowerQuery) ||
                    producto.marca.toLowerCase().includes(lowerQuery)
                );
            }

            // Funci√≥n para mostrar resultados
            function showResults(products) {
                searchResults.innerHTML = '';
                
                if (products.length === 0) {
                    searchResults.innerHTML = '<div class="no-results">No se encontraron productos</div>';
                    searchResults.classList.add('show');
                    return;
                }

                products.forEach((producto, index) => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.dataset.index = index;
                    item.dataset.productId = producto.id;
                    
                    item.innerHTML = `
                        <div class="product-info">
                            <div class="product-name">${producto.nombre}</div>
                            <div class="product-brand">${producto.marca}</div>
                        </div>
                        <div class="stock-info">
                            <div class="stock-amount">${producto.stock}</div>
                            <div class="stock-label">Stock</div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => selectProduct(producto));
                    item.addEventListener('mouseenter', () => {
                        selectedIndex = index;
                        updateSelection();
                    });
                    
                    searchResults.appendChild(item);
                });
                
                searchResults.classList.add('show');
                selectedIndex = -1;
            }

            // Funci√≥n para seleccionar producto
            function selectProduct(producto) {
                searchInput.value = `${producto.nombre} - ${producto.marca}`;
                hiddenInput.value = producto.id;
                searchResults.classList.remove('show');
                selectedIndex = -1;
            }

            // Funci√≥n para actualizar selecci√≥n visual
            function updateSelection() {
                const items = searchResults.querySelectorAll('.search-result-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });
            }

            // Event listener para el input de b√∫squeda
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                filteredProducts = filterProducts(query);
                showResults(filteredProducts);
            });

            // Event listener para teclas
            searchInput.addEventListener('keydown', function(e) {
                if (searchResults.classList.contains('show')) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, filteredProducts.length - 1);
                        updateSelection();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        updateSelection();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedIndex >= 0 && filteredProducts[selectedIndex]) {
                            selectProduct(filteredProducts[selectedIndex]);
                        }
                    } else if (e.key === 'Escape') {
                        searchResults.classList.remove('show');
                        selectedIndex = -1;
                    }
                }
            });

            // Event listener para hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.remove('show');
                    selectedIndex = -1;
                }
            });

            // Event listener para focus
            searchInput.addEventListener('focus', function() {
                if (this.value.trim().length >= 2) {
                    filteredProducts = filterProducts(this.value.trim());
                    showResults(filteredProducts);
                }
            });

            // Validaci√≥n de stock en tiempo real
            const cantidadInput = document.getElementById('cantidad');
            const form = document.querySelector('form');

            // Funci√≥n para validar stock
            function validateStock() {
                const cantidad = parseInt(cantidadInput.value) || 0;
                const productoId = hiddenInput.value;
                
                if (productoId && cantidad > 0) {
                    const producto = productosData.find(p => p.id == productoId);
                    if (producto && cantidad > producto.stock) {
                        cantidadInput.setCustomValidity(`Stock insuficiente. Disponible: ${producto.stock}, Solicitado: ${cantidad}`);
                        cantidadInput.style.borderColor = '#dc3545';
                        return false;
                    } else {
                        cantidadInput.setCustomValidity('');
                        cantidadInput.style.borderColor = '#e9ecef';
                        return true;
                    }
                }
                return true;
            }

            // Event listeners para validaci√≥n
            cantidadInput.addEventListener('input', validateStock);
            hiddenInput.addEventListener('change', validateStock);

            // Validaci√≥n antes de enviar el formulario
            form.addEventListener('submit', function(e) {
                if (!validateStock()) {
                    e.preventDefault();
                    alert('‚ùå Error: No hay suficiente stock disponible para la cantidad solicitada.');
                }
            });

            // Actualizar placeholder con stock disponible
            hiddenInput.addEventListener('change', function() {
                const productoId = this.value;
                if (productoId) {
                    const producto = productosData.find(p => p.id == productoId);
                    if (producto) {
                        cantidadInput.max = producto.stock;
                        cantidadInput.placeholder = `M√°ximo: ${producto.stock} unidades`;
                    }
                } else {
                    cantidadInput.max = '';
                    cantidadInput.placeholder = '';
                }
            });
        });

// === L√≥gica del modal de la creacion de maquina ===

        document.addEventListener('DOMContentLoaded', function() {
            
            // 1. SELECCIONAMOS EL BOT√ìN, NO EL FORMULARIO
            const btnGuardar = document.getElementById('btnGuardarMaquina');
            
            // Verificaci√≥n de seguridad
            if (btnGuardar) {
                btnGuardar.addEventListener('click', function(e) {
                    // Detenemos cualquier comportamiento por defecto o propagaci√≥n
                    e.preventDefault(); 
                    e.stopPropagation(); 
                    
                    const nombreInput = document.getElementById('nuevo_nombre_maquina');
                    const valorNombre = nombreInput ? nombreInput.value : '';
                    const ubicacionInput = document.getElementById('nuevo_ubicacion_maquina');
                    const valorUbicacion = ubicacionInput ? ubicacionInput.value : '';
                    
                    // Validaci√≥n simple
                    if (!valorNombre.trim()) {
                        alert("El nombre no puede estar vac√≠o");
                        return;
                    }

                    // Deshabilitar bot√≥n para evitar doble click
                    btnGuardar.disabled = true;
                    btnGuardar.innerText = "Guardando...";

                    // Tu funci√≥n fetch
                    fetch("{% url 'crear_maquinaRapido' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ nombre: valorNombre, ubicacion: valorUbicacion })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la red o servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
  if (data.success) {

    // 1) armamos el objeto producto tal como lo usa tu sistema
    const nuevaMaquina = {
      idMaquina: data.id,                       // ajust√° si tu backend devuelve otro nombre
      nombre: data.nombre,
      ubicacion: data.ubicacion
    };

    // 2) actualizamos el estado JS (la "verdad" de tu app)
    maquinas.push(nuevaMaquina);
    maquinaById.set(String(nuevaMaquina.idMaquina), nuevaMaquina);

    // 3) actualizamos la UI (select) con el mismo formato que el resto
    const select = document.getElementById('maquina');
    const option = document.createElement('option');
    option.value = String(nuevaMaquina.idMaquina);
    option.textContent = `${nuevaMaquina.nombre} - ${nuevaMaquina.ubicacion}`;
    select.appendChild(option);

    // 4) lo seleccionamos y DISPARAMOS el change
    select.value = String(nuevaMaquina.id);
    select.dispatchEvent(new Event('change'));

    // 5) limpiar y cerrar modal
    document.getElementById('nuevo_nombre_maquina').value = '';
    document.getElementById('nuevo_ubicacion_maquina').value = '';

    cerrarModalMaquina();

  } else {
    alert(data.error);
  }
})
                    .catch(error => {
                        console.error('Error:', error);
                        alert("Hubo un error al procesar la solicitud.");
                    })
                    .finally(() => {
                        // Reactivar bot√≥n siempre, pase lo que pase
                        btnGuardar.disabled = false;
                        btnGuardar.innerText = "Guardar";
                    });
                });
            } else {
                console.warn("‚ö†Ô∏è Advertencia: No se encontr√≥ el bot√≥n con ID 'btnGuardarProductoRapido'. Revisa tu HTML.");
            }
        });

        // --- FUNCIONES GLOBALES ---

        function abrirModalMaquina() {
            const modal = document.getElementById('modalNuevaMaquina');
            if (modal) {
                modal.style.display = 'flex'; // O 'block', seg√∫n tu CSS
                setTimeout(() => {
                    const input = document.getElementById('nuevo_nombre_maquina');
                    if(input) input.focus();
                }, 100);
            }
        }

        function cerrarModalMaquina() {
            const modal = document.getElementById('modalNuevaMaquina');
            if (modal) modal.style.display = 'none';
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Esc para cerrar
            function onEsc(e) { if (e.key === 'Escape') cerrarModalMaquina(); }
            document.addEventListener('keydown', onEsc);
            overlay._onEsc = onEsc;

            // Click fuera cierra
            function onOverlayClick(e) { if (e.target === overlay) cerrarModalMaquina(); }
            overlay.addEventListener('click', onOverlayClick);
            overlay._onOverlayClick = onOverlayClick;








    </script>
</body>
</html>
