{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Compra</title>
    <link rel="stylesheet" href="{% static 'registrarCompra.css' %}">
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>üõí Registrar Nueva Compra</h1>
            <p>Complete los datos de la compra recibida</p>
        </div>

        <div class="content">
            <div class="navigation">
                <a href="{% url 'index' %}" class="back-btn">‚Üê Volver al Inicio</a>
                <span>Usuario: {{ request.session.user_name }}</span>
            </div>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{% if message.tags == 'error' %}error{% else %}success{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <form method="POST" id="compraForm">
                {% csrf_token %}
                
                <!-- Secci√≥n 1: Informaci√≥n General de la Compra -->
                <div class="form-section">
                    <h2>üìã Informaci√≥n General</h2>
                    
                    <div class="form-group">
                        <label for="proveedor">Proveedor *</label>
                        <select name="proveedor" id="proveedor" required>
                            <option value="">Seleccione un proveedor</option>
                            {% for proveedor in proveedores %}
                                <option value="{{ proveedor.idProveedor }}">{{ proveedor.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="lugar">Ciudad *</label>
                        <select name="lugar" id="lugar" required>
                            <option value="">Seleccione una ciudad</option>
                            {% for ciudad in ciudades %}
                                <option value="{{ ciudad.id }}">{{ ciudad.nombre }} ({{ ciudad.codPostal }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="importe_total">Importe Total de la Compra ($)  *</label>
                        <input type="number" name="importe_total" id="importe_total" step="0.01" min="0" required 
                               placeholder="Ingrese el importe total de la factura">
                    </div>
                </div>

                <!-- Secci√≥n 2: Detalles de Productos -->
                <div class="form-section">
                    <h2>üì¶ Detalles de Productos</h2>
                    
                    <div class="detalles-container" id="detallesContainer">
                        <!-- Los detalles se agregar√°n din√°micamente aqu√≠ -->
                    </div>

                    <button type="button" class="btn btn-success" onclick="agregarDetalle()">
                        ‚ûï Agregar Producto
                    </button>
                </div>

                <!-- Secci√≥n 3: Resumen y Validaci√≥n -->
                <div class="resumen" id="resumen" style="display: none;">
                    <h3>üìä Resumen de la Compra</h3>
                    <div id="resumenDetalles"></div>
                    <div class="resumen-item resumen-total">
                        <span>Total Calculado:</span>
                        <span id="totalCalculado">$0.00</span>
                    </div>
                    <div class="resumen-item resumen-total">
                        <span>Importe Declarado:</span>
                        <span id="importeDeclarado">$0.00</span>
                    </div>
                    <div class="resumen-item resumen-total" id="diferencia">
                        <span>Diferencia:</span>
                        <span id="diferenciaValor">$0.00</span>
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" id="btnGuardar" disabled>
                        üíæ Guardar Compra
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                        üîÑ Limpiar Formulario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let contadorDetalles = 0;
        const productos = {{ productos_json|safe }};

        function agregarDetalle() {
            contadorDetalles++;
            const container = document.getElementById('detallesContainer');
            
            const detalleHTML = `
                <div class="detalle-item" id="detalle-${contadorDetalles}">
                    <select name="producto_${contadorDetalles}" required onchange="actualizarPrecio(${contadorDetalles})">
                        <option value="">Seleccione producto</option>
                        ${productos.map(p => `<option value="${p.id}" data-precio="${p.precioUnitario}">${p.nombre} - ${p.marca}</option>`).join('')}
                    </select>
                    <input type="number" name="cantidad_${contadorDetalles}" placeholder="Cantidad" min="1" required onchange="calcularSubtotal(${contadorDetalles})">
                    <div class="precio-container">
                        <input type="number" name="precio_unitario_${contadorDetalles}" placeholder="Precio unitario" step="0.01" min="0" required onchange="calcularSubtotal(${contadorDetalles})" readonly>
                        <button type="button" class="btn-editar-precio" onclick="toggleAbrirPopover(${contadorDetalles})">‚úèÔ∏è</button>
    
                        <div class="precio-popover" id="popover-${contadorDetalles}">
                            <input type="number" class="input-precio-popover" id="input-precio-${contadorDetalles}" step="0.01" min="0.01">
                            <button class="btn-guardar-popover" onclick="guardarPrecioPopover(${contadorDetalles})">‚úì</button>
                            <button class="btn-cancelar-popover" onclick="cerrarPopover(${contadorDetalles})">‚úï</button>
                        </div>
                    </div>
                    <input type="number" name="subtotal_${contadorDetalles}" placeholder="Subtotal" step="0.01" readonly>
                    <button type="button" class="btn btn-danger" onclick="eliminarDetalle(${contadorDetalles})">üóëÔ∏è</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', detalleHTML);
            actualizarResumen();
        }

        function eliminarDetalle(id) {
            const detalle = document.getElementById(`detalle-${id}`);
            detalle.remove();
            actualizarResumen();
        }

        function actualizarPrecio(id) {
            const select = document.querySelector(`#detalle-${id} select`);
            const precioInput = document.querySelector(`#detalle-${id} input[name="precio_unitario_${id}"]`);
            const precioPopoverInput = document.getElementById(`input-precio-${id}`);
            const cantidadInput = document.querySelector(`#detalle-${id} input[name="cantidad_${id}"]`);
            
            const option = select.options[select.selectedIndex];
            if (option.value) {
                precioInput.value = option.dataset.precio;
                precioPopoverInput.value = option.dataset.precio; // Sincronizar el popover
                // Si ya hay cantidad ingresada, recalcular subtotal
                if (cantidadInput.value) {
                    calcularSubtotal(id);
                }
            }
        }

//Logica de Popover para cambiar de precios

        // Variable para rastrear qu√© popover est√° abierto
        let popoverAbierto = null;

        function toggleAbrirPopover(productoId) {
            // Cerrar cualquier popover abierto
            if (popoverAbierto && popoverAbierto !== productoId) {
                cerrarPopover(popoverAbierto);
            }
            
            const popover = document.getElementById(`popover-${productoId}`);
            const input = document.getElementById(`input-precio-${productoId}`);
            
            if (popover.style.display === 'none' || !popover.style.display) {
                // Mostrar popover
                popover.style.display = 'block';
                input.focus();
                input.select(); // Seleccionar todo el texto para edici√≥n r√°pida
                popoverAbierto = productoId;
                
                // Cerrar si se hace clic fuera del popover
                setTimeout(() => {
                    document.addEventListener('click', cerrarPopoverGlobal);
                }, 100);
            } else {
                cerrarPopover(productoId);
            }
        }



        function guardarPrecioPopover(id) {
            const nuevoValor = document.getElementById(`input-precio-${id}`).value; 
            if (parseFloat(nuevoValor) <= 0) {
                alert('El precio debe ser mayor a 0');
                return;
            }
            
            // Actualizar el input principal
            document.querySelector(`#detalle-${id} input[name="precio_unitario_${id}"]`).value = nuevoValor;
            
            // Recalcular subtotal
            calcularSubtotal(id);
            
            // Cerrar popover
            cerrarPopover(id);
        }
        function cerrarPopover(productoId) {
            const popover = document.getElementById(`popover-${productoId}`);
            popover.style.display = 'none';
            popoverAbierto = null;
            document.removeEventListener('click', cerrarPopoverGlobal);
        }

        function cerrarPopoverGlobal(event) {
            // Cerrar popover si se hace clic fuera de √©l
            if (!event.target.closest('.precio-popover') && !event.target.closest('.btn-editar-precio')) {
                if (popoverAbierto) {
                    cerrarPopover(popoverAbierto);
                }
            }
        }

//Fin logica de popover

        function calcularSubtotal(id) {
            const cantidad = parseFloat(document.querySelector(`#detalle-${id} input[name="cantidad_${id}"]`).value) || 0;
            const precio = parseFloat(document.querySelector(`#detalle-${id} input[name="precio_unitario_${id}"]`).value) || 0;
            const subtotal = cantidad * precio;
            
            document.querySelector(`#detalle-${id} input[name="subtotal_${id}"]`).value = subtotal.toFixed(2);
            actualizarResumen();
        }

        function actualizarResumen() {
            const detalles = document.querySelectorAll('.detalle-item');
            let totalCalculado = 0;
            let resumenHTML = '';

            detalles.forEach((detalle, index) => {
                const producto = detalle.querySelector('select').options[detalle.querySelector('select').selectedIndex].text;
                const cantidad = detalle.querySelector('input[placeholder="Cantidad"]').value;
                const precio = detalle.querySelector('input[placeholder="Precio unitario"]').value;
                const subtotal = detalle.querySelector('input[placeholder="Subtotal"]').value;

                if (producto && cantidad && precio && subtotal) {
                    totalCalculado += parseFloat(subtotal);
                    resumenHTML += `
                        <div class="resumen-item">
                            <span>${producto} (${cantidad} x $${precio})</span>
                            <span>$${subtotal}</span>
                        </div>
                    `;
                }
            });

            const importeDeclarado = parseFloat(document.getElementById('importe_total').value) || 0;
            const diferencia = importeDeclarado - totalCalculado;

            document.getElementById('resumenDetalles').innerHTML = resumenHTML;
            document.getElementById('totalCalculado').textContent = `$${totalCalculado.toFixed(2)}`;
            document.getElementById('importeDeclarado').textContent = `$${importeDeclarado.toFixed(2)}`;
            document.getElementById('diferenciaValor').textContent = `$${diferencia.toFixed(2)}`;

            // Mostrar/ocultar resumen
            const resumen = document.getElementById('resumen');
            if (totalCalculado > 0) {
                resumen.style.display = 'block';
            } else {
                resumen.style.display = 'none';
            }

            // Validar diferencia
            const diferenciaElement = document.getElementById('diferencia');
            if (Math.abs(diferencia) > 0.01) {
                diferenciaElement.style.color = '#dc3545';
                document.getElementById('btnGuardar').disabled = true;
            } else {
                diferenciaElement.style.color = '#28a745';
                document.getElementById('btnGuardar').disabled = false;
            }
        }

        function limpiarFormulario() {
            document.getElementById('compraForm').reset();
            document.getElementById('detallesContainer').innerHTML = '';
            document.getElementById('resumen').style.display = 'none';
            document.getElementById('btnGuardar').disabled = true;
            contadorDetalles = 0;
        }

        // Event listeners
        document.getElementById('importe_total').addEventListener('input', actualizarResumen);
        
        // Agregar primer detalle al cargar la p√°gina
        window.onload = function() {
            agregarDetalle();
        };

        // Prevenir env√≠o del formulario con Enter
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                return false;
            }
        });
    </script>
</body>
</html>