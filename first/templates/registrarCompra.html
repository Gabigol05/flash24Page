{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Compra</title>
    <link rel="stylesheet" href="{% static 'registrarCompra.css' %}">
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>üõí Registrar Nueva Compra</h1>
            <p>Complete los datos de la compra recibida</p>
        </div>

        <div class="content">
            <div class="navigation">
                <a href="{% url 'index' %}" class="back-btn">‚Üê Volver al Inicio</a>
                <span>Usuario: {{ request.session.user_name }}</span>
            </div>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{% if message.tags == 'error' %}error{% else %}success{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <form method="POST" id="compraForm">
                {% csrf_token %}
                
                <!-- Secci√≥n 1: Informaci√≥n General de la Compra -->
                <div class="form-section">
                    <h2>üìã Informaci√≥n General</h2>
                    
                    <div class="form-group">
                        <label for="proveedor">Proveedor *</label>
                        <select name="proveedor" id="proveedor" required>
                            <option value="">Seleccione un proveedor</option>
                            {% for proveedor in proveedores %}
                                <option value="{{ proveedor.idProveedor }}">{{ proveedor.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="lugar">Ciudad *</label>
                        <select name="lugar" id="lugar" required>
                            <option value="">Seleccione una ciudad</option>
                            {% for ciudad in ciudades %}
                                <option value="{{ ciudad.id }}">{{ ciudad.nombre }} ({{ ciudad.codPostal }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="importe_total">Importe Total de la Compra ($)  *</label>
                        <input type="number" name="importe_total" id="importe_total" step="0.01" min="0" required 
                               placeholder="Ingrese el importe total de la factura">
                    </div>
                </div>

                <!-- Secci√≥n 2: Editor √önico de Producto (sin lista larga) -->
                <div class="form-section">
                    <h2>üì¶ Seccion de ingreso de productos </h2>

                    <div class="detalle-editor" id="detalleEditor">
                        <!-- Producto -->
                        <div class="form-group">
                            <label for="editor-producto">Producto *</label>
                            <select id="editor-producto">
                                <option value="">Seleccione producto</option>
                                <!-- opciones se cargan desde productos_json -->
                            </select>
                        </div>

                        <!-- Cantidad -->
                        <div class="form-group">
                            <label for="editor-cantidad">Cantidad *</label>
                            <input type="number" id="editor-cantidad" placeholder="Cantidad" min="1" step="1">
                        </div>

                        <!-- Precio con popover de override -->
                        <div class="form-group precio-container">
                            <label for="editor-precio">Precio unitario </label>
                            <div class="precio-inline">
                                <input type="number" id="editor-precio" placeholder="Precio unitario" step="0.01" min="0.01" readonly>
                                <button type="button" class="btn-editar-precio" id="btnEditarPrecioEditor">‚úèÔ∏è</button>
                            </div>
                            <div class="precio-popover" id="popover-editor" style="display:none;">
                                <input type="number" class="input-precio-popover" id="input-precio-editor" step="0.01" min="0.01">
                                <button type="button" class="btn-guardar-popover" id="btnGuardarPrecioEditor">‚úì</button>
                                <button type="button" class="btn-cancelar-popover" id="btnCancelarPrecioEditor">‚úï</button>
                            </div>
                        </div>

                        <!-- Acciones del editor -->
                        <div class="editor-actions">
                            <button type="button" class="btn btn-success" id="btnAgregar">‚ûï Agregar</button>
                        </div>


                    </div>
                </div>

                <!-- Secci√≥n 3: Resumen y Validaci√≥n (siempre visible, sin scrollear) -->
                <div class="resumen" id="resumen-acciones">
                    <div class="resumen-item resumen-total">
                        <span>Total Calculado:</span>
                        <span id="totalCalculado">$0.00</span>
                    </div>
                    <div class="resumen-item resumen-total">
                        <span>Importe Declarado:</span>
                        <span id="importeDeclarado">$0.00</span>
                    </div>
                    <div class="resumen-item resumen-total" id="diferencia">
                        <span>Diferencia:</span>
                        <span id="diferenciaValor">$0.00</span>
                    </div>
                    <button type="button" class="btn btn-info" id="btnVerResumen" onclick="abrirResumenModal()">
                        üëÅÔ∏è Ver resumen completo
                    </button>
                </div>

                <!-- Botones de Acci√≥n -->
                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" id="btnGuardar" disabled>
                        üíæ Guardar Compra
                    </button>
                    <button type="button" class="btn btn-secondary" id="btnLimpiar">
                        üîÑ Limpiar Formulario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Resumen Completo -->
    <div id="modal-resumen" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Resumen de la compra</h3>
                <button type="button" class="btn-cerrar" onclick="cerrarResumenModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modal-resumen-body"></div>
        </div>
    </div>

    <script>
        /* =========================
           Estado y helpers
        ========================== */
        const productos = {{ productos_json|safe }}; // [{id, nombre, marca, precioUnitario}, ...]
        const prodById = new Map(productos.map(p => [String(p.id), p])); // lookup r√°pido

        // Array maestro de detalles (Opci√≥n 2: estado en memoria)
        // Cada item: { uid, productoId, nombre, marca, cantidad, precioUnitario, subtotal, overridePrecio }
        let detalles = [];
        let nextUid = 1;

        // Control popover del editor
        let popoverEditorAbierto = false;

        // Referencias a elementos
        const selProducto = document.getElementById('editor-producto');
        const inpCantidad = document.getElementById('editor-cantidad');
        const inpPrecio    = document.getElementById('editor-precio');
        const btnAgregar   = document.getElementById('btnAgregar');
        const btnVerResumen = document.getElementById('btnVerResumen');
        const btnGuardar   = document.getElementById('btnGuardar');
        const btnLimpiar   = document.getElementById('btnLimpiar');

        const importeTotalInput = document.getElementById('importe_total');
        const totalCalculadoSpan = document.getElementById('totalCalculado');
        const importeDeclaradoSpan = document.getElementById('importeDeclarado');
        const diferenciaValorSpan = document.getElementById('diferenciaValor');

        const popoverEditor = document.getElementById('popover-editor');
        const inputPrecioEditor = document.getElementById('input-precio-editor');
        const btnEditarPrecioEditor = document.getElementById('btnEditarPrecioEditor');
        const btnGuardarPrecioEditor = document.getElementById('btnGuardarPrecioEditor');
        const btnCancelarPrecioEditor = document.getElementById('btnCancelarPrecioEditor');

        const form = document.getElementById('compraForm');

        /* =========================
           Inicializaci√≥n de opciones de producto
        ========================== */
        (function initProductoOptions() {
            // Poblar el select con los productos
            const opts = ['<option value="">Seleccione producto</option>']
                .concat(productos.map(p => 
                    `<option value="${p.id}" data-precio="${p.precioUnitario}">
                        ${p.nombre} - ${p.marca}
                    </option>`
                ));
            selProducto.innerHTML = opts.join('');
        })();

        /* =========================
           Validaciones
        ========================== */
        function editorValido() {
            const prodId = selProducto.value.trim();
            const cant = parseFloat(inpCantidad.value);
            const precio = parseFloat(inpPrecio.value);
            return (
                prodId !== '' &&
                Number.isFinite(cant) && cant >= 1 && Number.isInteger(Number(cant)) &&
                Number.isFinite(precio) && precio > 0
            );
        }

        function setAgregarEnabled() {
            btnAgregar.disabled = !editorValido();
        }

        /* =========================
           Listeners del Editor
        ========================== */
        // Producto ‚Üí setear precio default
        selProducto.addEventListener('change', () => {
            const prodId = selProducto.value;
            if (!prodId) {
                inpPrecio.value = '';
                return;
            }
            const prod = prodById.get(String(prodId));
            if (prod) {
                inpPrecio.value = Number(prod.precioUnitario).toFixed(2);
                inputPrecioEditor.value = Number(prod.precioUnitario).toFixed(2);
            }
            setAgregarEnabled();
        });

        // Cantidad / Precio ‚Üí validar
        inpCantidad.addEventListener('input', setAgregarEnabled);
        inpPrecio.addEventListener('input', setAgregarEnabled);

        // Popover editar precio (override)
        btnEditarPrecioEditor.addEventListener('click', () => {
            if (!selProducto.value) {
                alert('Seleccione un producto antes de editar el precio.');
                return;
            }
            if (popoverEditor.style.display === 'none' || !popoverEditor.style.display) {
                popoverEditor.style.display = 'block';
                inputPrecioEditor.value = inpPrecio.value || '';
                inputPrecioEditor.focus();
                inputPrecioEditor.select();
                popoverEditorAbierto = true;
                setTimeout(() => document.addEventListener('click', cerrarPopoverGlobalEditor), 0);
            } else {
                cerrarPopoverEditor();
            }
        });

        btnGuardarPrecioEditor.addEventListener('click', () => {
            const nuevo = parseFloat(inputPrecioEditor.value);
            if (!Number.isFinite(nuevo) || nuevo <= 0) {
                alert('El precio debe ser mayor a 0.');
                return;
            }
            inpPrecio.value = nuevo.toFixed(2);
            cerrarPopoverEditor();
            setAgregarEnabled();
        });

        btnCancelarPrecioEditor.addEventListener('click', cerrarPopoverEditor);

        function cerrarPopoverEditor() {
            popoverEditor.style.display = 'none';
            popoverEditorAbierto = false;
            document.removeEventListener('click', cerrarPopoverGlobalEditor);
        }

        function cerrarPopoverGlobalEditor(e) {
            if (!e.target.closest('.precio-popover') && !e.target.closest('.btn-editar-precio')) {
                cerrarPopoverEditor();
            }
        }

        // Enter para agregar, Esc para cerrar popover
        document.addEventListener('keydown', (e) => {
            if (popoverEditorAbierto && e.key === 'Escape') {
                cerrarPopoverEditor();
            } else if (!popoverEditorAbierto && e.key === 'Enter') {
                // Si el foco est√° dentro del editor, agregamos
                const dentroEditor = e.target.closest('#detalleEditor');
                if (dentroEditor) {
                    e.preventDefault();
                    if (editorValido()) agregarDesdeEditor();
                }
            }
        });

        btnAgregar.addEventListener('click', agregarDesdeEditor);

        /* =========================
           L√≥gica de agregar (Ideas 2 y 4)
        ========================== */
        function agregarDesdeEditor() {
            if (!editorValido()) {
                alert('Complete producto, cantidad (entera ‚â•1) y precio (>0).');
                return;
            }
            const prodId = selProducto.value.trim();
            const prod = prodById.get(String(prodId));
            const cantidad = parseInt(inpCantidad.value, 10);
            const precio = parseFloat(inpPrecio.value);

            // override si difiere del precio default del producto
            const overridePrecio = Math.abs(precio - Number(prod.precioUnitario)) > 1e-9;

            // Opci√≥n A: Merge por (productoId, precioUnitario)
            const existed = detalles.find(it => it.productoId === prodId && Math.abs(it.precioUnitario - precio) < 1e-9);
            if (existed) {
                existed.cantidad += cantidad;
                existed.subtotal = existed.cantidad * existed.precioUnitario;
                // si hubo override en esta carga, marcarlo
                existed.overridePrecio = existed.overridePrecio || overridePrecio;
            } else {
                detalles.push({
                    uid: nextUid++,
                    productoId: prodId,
                    nombre: prod.nombre,
                    marca: prod.marca,
                    cantidad: cantidad,
                    precioUnitario: precio,
                    subtotal: cantidad * precio,
                    overridePrecio: overridePrecio
                });
            }

            // Limpiar editor (Idea 2)
            limpiarEditor();

            // Actualizar resumen
            actualizarResumenUI();
        }

        function limpiarEditor() {
            selProducto.value = '';
            inpCantidad.value = '';
            inpPrecio.value = '';
            inputPrecioEditor.value = '';
            setAgregarEnabled();
            selProducto.focus();
        }

        /* =========================
           Resumen siempre visible + habilitar botones
        ========================== */
        function formatoMoneda(n) {
            const val = Number(n || 0);
            return '$' + val.toFixed(2);
        }

        function totalCalculado() {
            return detalles.reduce((acc, it) => acc + it.subtotal, 0);
        }

        function actualizarResumenUI() {
            const total = totalCalculado();
            const declarado = parseFloat(importeTotalInput.value) || 0;
            const dif = declarado - total;

            totalCalculadoSpan.textContent = formatoMoneda(total);
            importeDeclaradoSpan.textContent = formatoMoneda(declarado);
            diferenciaValorSpan.textContent = formatoMoneda(dif);
        }

        importeTotalInput.addEventListener('input', actualizarResumenUI);

        /* =========================
           Modal de Resumen (Idea 3 y 8)
        ========================== */
        function abrirResumenModal() {
            const overlay = document.getElementById('modal-resumen');
            const body = document.getElementById('modal-resumen-body');

            body.innerHTML = construirTablaResumenHTML();
            overlay.style.display = 'flex';

            // Delegaci√≥n de eventos para Editar/Eliminar/Guardar/Cancelar dentro del modal
            body.addEventListener('click', onClickTablaResumen);
            body._delegated = true;

            // Esc para cerrar
            function onEsc(e) { if (e.key === 'Escape') cerrarResumenModal(); }
            document.addEventListener('keydown', onEsc);
            overlay._onEsc = onEsc;

            // Click fuera cierra
            function onOverlayClick(e) { if (e.target === overlay) cerrarResumenModal(); }
            overlay.addEventListener('click', onOverlayClick);
            overlay._onOverlayClick = onOverlayClick;
        }

        function cerrarResumenModal() {
            const overlay = document.getElementById('modal-resumen');
            const body = document.getElementById('modal-resumen-body');

            if (body._delegated) {
                body.removeEventListener('click', onClickTablaResumen);
                body._delegated = false;
            }

            overlay.style.display = 'none';

            if (overlay._onEsc) {
                document.removeEventListener('keydown', overlay._onEsc);
                overlay._onEsc = null;
            }
            if (overlay._onOverlayClick) {
                overlay.removeEventListener('click', overlay._onOverlayClick);
                overlay._onOverlayClick = null;
            }
        }

        function construirTablaResumenHTML() {
            let filas = detalles.map(it => `
                <tr data-uid="${it.uid}">
                    <td>${it.nombre} - ${it.marca}</td>
                    <td class="td-cantidad">${it.cantidad}</td>
                    <td class="td-precio">${formatoMoneda(it.precioUnitario)}</td>
                    <td class="td-subtotal">${formatoMoneda(it.subtotal)}</td>
                    <td class="td-acciones">
                        <button type="button" class="btn btn-sm btn-outline" data-action="editar" aria-label="Editar">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-sm btn-danger" data-action="eliminar">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            if (filas.trim() === '') {
                filas = `<tr><td colspan="5" style="text-align:center;">Sin productos cargados</td></tr>`;
            }

            const total = totalCalculado();

            return `
                <table class="tabla-resumen">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-resumen">
                        ${filas}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3">Total</td>
                            <td>${formatoMoneda(total)}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            `;
        }

        function onClickTablaResumen(e) {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const action = btn.getAttribute('data-action');
            const tr = e.target.closest('tr[data-uid]');
            if (!tr) return;
            const uid = parseInt(tr.getAttribute('data-uid'), 10);
            const item = detalles.find(it => it.uid === uid);
            if (!item) return;

            if (action === 'eliminar') {
                // Eliminar del array
                detalles = detalles.filter(it => it.uid !== uid);
                // Re-render modal body y resumen UI
                document.getElementById('modal-resumen-body').innerHTML = construirTablaResumenHTML();
                actualizarResumenUI();
                return;
            }

            if (action === 'editar') {
                // Cambiar fila a modo edici√≥n (cantidad y precio)
                toRowEditMode(tr, item);
                return;
            }

            if (action === 'guardar-edicion') {
                const inpCant = tr.querySelector('input[name="edit-cantidad"]');
                const inpPrec = tr.querySelector('input[name="edit-precio"]');
                const nuevaCant = parseInt(inpCant.value, 10);
                const nuevoPrec = parseFloat(inpPrec.value);

                if (!Number.isInteger(nuevaCant) || nuevaCant < 1) {
                    alert('Cantidad debe ser un entero ‚â• 1.');
                    return;
                }
                if (!Number.isFinite(nuevoPrec) || nuevoPrec <= 0) {
                    alert('Precio debe ser mayor a 0.');
                    return;
                }

                // Si cambi√≥ el precio, ver si existe otra l√≠nea con (mismo productoId, nuevoPrec) para merge
                const sameLine = detalles.find(it => it.uid === uid);
                const other = detalles.find(it => it.uid !== uid && it.productoId === sameLine.productoId && Math.abs(it.precioUnitario - nuevoPrec) < 1e-9);

                // Actualizar/merge
                if (other) {
                    other.cantidad += nuevaCant;
                    other.subtotal = other.cantidad * other.precioUnitario;
                    // override si difiere del default
                    const defaultP = Number(prodById.get(String(other.productoId)).precioUnitario);
                    other.overridePrecio = other.overridePrecio || Math.abs(nuevoPrec - defaultP) > 1e-9;
                    // eliminar la l√≠nea actual
                    detalles = detalles.filter(it => it.uid !== uid);
                } else {
                    sameLine.cantidad = nuevaCant;
                    sameLine.precioUnitario = nuevoPrec;
                    sameLine.subtotal = nuevaCant * nuevoPrec;
                    const defaultP = Number(prodById.get(String(sameLine.productoId)).precioUnitario);
                    sameLine.overridePrecio = Math.abs(nuevoPrec - defaultP) > 1e-9;
                }

                // Re-render
                document.getElementById('modal-resumen-body').innerHTML = construirTablaResumenHTML();
                actualizarResumenUI();
                return;
            }

            if (action === 'cancelar-edicion') {
                // Re-render sin cambios
                document.getElementById('modal-resumen-body').innerHTML = construirTablaResumenHTML();
                return;
            }
        }

        function toRowEditMode(tr, item) {
            const tdCantidad = tr.querySelector('.td-cantidad');
            const tdPrecio = tr.querySelector('.td-precio');
            const tdSubtotal = tr.querySelector('.td-subtotal');
            const tdAcciones = tr.querySelector('.td-acciones');

            tdCantidad.innerHTML = `<input type="number" name="edit-cantidad" min="1" step="1" value="${item.cantidad}">`;
            tdPrecio.innerHTML = `<input type="number" name="edit-precio" min="0.01" step="0.01" value="${item.precioUnitario.toFixed(2)}">`;
            tdSubtotal.textContent = '‚Äî';
            tdAcciones.innerHTML = `
                <button type="button" class="btn btn-sm btn-primary" data-action="guardar-edicion">Guardar</button>
                <button type="button" class="btn btn-sm btn-outline" data-action="cancelar-edicion">Cancelar</button>
            `;
        }

        /* =========================
           Submit (Idea 5 - Opci√≥n 1)
        ========================== */
        form.addEventListener('submit', (e) => {
            // Validaci√≥n b√°sica antes de serializar
            if (detalles.length === 0) {
                e.preventDefault();
                alert('No hay productos cargados.');
                return;
            }
            const declarado = parseFloat(importeTotalInput.value) || 0;
            const dif = declarado - totalCalculado();
            if (Math.abs(dif) > 0.01) {
                e.preventDefault();
                alert('La diferencia debe ser 0 (¬±0,01). Revise los montos.');
                return;
            }

            // Limpiar inputs ocultos anteriores (por si hubo submit previo cancelado)
            Array.from(form.querySelectorAll('input[type="hidden"].hidden-detalle, input[type="hidden"].hidden-override'))
                 .forEach(el => el.remove());

            // Serializar detalles: producto_i, cantidad_i, precio_unitario_i, subtotal_i
            detalles.forEach((it, idx) => {
                const i = idx + 1;
                crearHidden(`producto_${i}`, it.productoId, 'hidden-detalle');
                crearHidden(`cantidad_${i}`, String(it.cantidad), 'hidden-detalle');
                crearHidden(`precio_unitario_${i}`, Number(it.precioUnitario).toFixed(2), 'hidden-detalle');
                crearHidden(`subtotal_${i}`, Number(it.subtotal).toFixed(2), 'hidden-detalle');
            });
            crearHidden('detalles_count', String(detalles.length), 'hidden-detalle');

            // Flags de override de precio por productId
            // Si hay m√∫ltiples overrides para el mismo producto con distintos precios,
            // priorizamos la √∫ltima l√≠nea encontrada.
            const overrides = new Map(); // productId -> nuevoPrecio
            for (const it of detalles) {
                if (it.overridePrecio) {
                    overrides.set(it.productoId, Number(it.precioUnitario).toFixed(2));
                }
            }
            overrides.forEach((nuevoPrecio, productId) => {
                crearHidden(`precio_changed_${productId}`, '1', 'hidden-override');
                crearHidden(`nuevo_precio_${productId}`, nuevoPrecio, 'hidden-override');
            });

            // Deshabilitar el bot√≥n para evitar doble submit
            btnGuardar.disabled = true;
        });

        function crearHidden(name, value, cls) {
            const h = document.createElement('input');
            h.type = 'hidden';
            h.name = name;
            h.value = value;
            h.className = cls;
            form.appendChild(h);
        }

        /* =========================
           Limpiar formulario (estado + UI)
        ========================== */
        btnLimpiar.addEventListener('click', limpiarFormulario);
        function limpiarFormulario() {
            form.reset();
            detalles = [];
            nextUid = 1;
            limpiarEditor();
            actualizarResumenUI();
        }

        /* =========================
           Arranque
        ========================== */
        // Estado inicial
        setAgregarEnabled();
        actualizarResumenUI();
    </script>
</body>
</html>
